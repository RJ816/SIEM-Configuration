<!DOCTYPE html>

<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
<style>* {font-family: Arial, Helvetica, sans-serif;}</style>
<title>SIEM Configuration</title>
</head>

<body class="container-fluid">
    
<div class="row display-4 justify-content-center fw-bolder mb-5">SIEM Configuration</div>

<div class="row fw-bold p-0 m-0 mb-3">Overview</div>
<div class="row m-0 p-0 mb-5">
  Configured Winlogbeat agent, Wazuh HIDS, syslog, and pfSense firewall to manage various log types on SIEM utilizing Elastic Stack (Logstash, ElasticSearch, and Kibana).
</div>

<div class="row fw-bold p-0 m-0 mb-3">Lab Environment</div>
<div class="row m-0 p-0">
  <ul>
    <li>SIEM1 (SIEM)</li>
    <li>PC1 (Host)</li>
    <li>DC1 (Beats Agent)</li>
    <li>MS1 (IIS Server)</li>
    <li>MS1 (IIS Server)</li>
    <li>UTM1 (pfSense Firwall Host)</li>
  </ul>
</div>

<div class="row fw-bold m-0 p-0 mb-3">Network Sensor Interface Configuration</div>
<div class="row m-0 p-0">
  SIEM1 has two network interfaces. eth0 is a management interface with IP address 10.1.0.246. 
  eth1 has no IP address and is used to sniff traffic in the local network.
  On the terminal the following command tested the port mirroring.
  <code>sudo tcpdump -ni eth1 ip</code>
  <div class="row mb-5 justify-content-center"><img src="images/1.png" alt="1" class="col-lg-6"></div>
  Traffic is already monitored by Zeek (Bro). 
  Filter rules send notable events to SIEM1's logging engine Elastic Stack (Logstash, ElasticSearch, and Kibana).
  The following command can be used to check on all services.
  <code>sudo so-status</code>
  Kibana is a visual tool used to configure dashboards for different categories, showing data in graph and table formats.
  Connections can be selected to check all the local host IPs are present.
  <div class="row mb-5 justify-content-center"><img src="images/2.png" alt="2" class="col-lg-6"></div>
  On PC1, Zenmap was used to perform a default intense scan against 10.1.0.1.
  <div class="row mb-5 justify-content-center"><img src="images/3.png" alt="3" class="col-lg-6"></div>
  On SIEM1 in Kibana, Zeek notices and NIDS categories for scanning activity can be seen.
  The NIDS alert was generated by a Snort IDS engine and rule set.
  <div class="row mb-5 justify-content-center"><img src="images/4.png" alt="4" class="col-lg-6"></div>
</div>

<div class="row fw-bold m-0 p-0 mb-3">Beats Agent Configuration</div>
<div class="row m-0 p-0">
  Winlogbeat (Beats) collects Windows logs, acting as a Agent for it's respective host.  
  In DC1 in the winlogbeat.yml file, under the "output.logstash:" section, hosts IP was changed to 10.1.0.246 port 5044.
  Note: yaml files are white space sensitive. 
  Settings are grouped by indentation and tabs should not be used.
  Conventional rules use two spaces per indentation level. 
  <div class="row mb-5 justify-content-center"><img src="images/5.png" alt="5" class="col-lg-6"></div>
  ElasticSearch provides storage and query functionality. 
  Logstash is an engine for collecting different types of data from various sources via a pipeline. 
  The pipeline takes inputs, such as syslog or a Beats agent, and filters the data to normalize it.
  Moving the edited configuration file to Program Files, it can be tested with the following terminal command:
  <code>cd &#39;C:\Program Files (x86)\winlogbeat&#39;</code>
  <code>.\winlogbeat test config -c winlogbeat.yml -e</code>  
  The end of the output should read "Config OK." if done correctly.  
  <div class="row mb-5 justify-content-center"><img src="images/6.png" alt="6" class="col-lg-6"></div>  
  The following two commands install and start the service.
  <code>.\install-service-winlogbeat</code>
  <code>start-service winlogbeat</code>
  In SIEM1, the following command shows the firewall configuration.
  <code>sudo so-allow-view</code>  
  <div class="row mb-5 justify-content-center"><img src="images/7.png" alt="7" class="col-lg-6"></div>  
  It has been set to allow traffic over the Beats port 5044.
  Logstash and other components run in Docker containers.
  In SIEM1, alerts should be generated from the Agent activity. 
</div>

<div class="row fw-bold m-0 p-0 mb-3">Application Logging Configuration</div>
<div class="row m-0 p-0">
  In MS1 under Internet Information Services Manager, the Logging applet was selected configure application logs to send to SIEM1.
  <div class="row mb-5 justify-content-center"><img src="images/8.png" alt="8" class="col-lg-6"></div>
  Under Log Event Destination, "both log file and ETW event" was selected and applied.
  <div class="row mb-5 justify-content-center"><img src="images/9.png" alt="9" class="col-lg-6"></div>
  The following command can retreive the name of the event log capturing IIS access events.
  <code>get-winevent -listlog * | where-object { $_.logname -like “*IIS*”} | format-list -property logname</code>  
  <div class="row mb-5 justify-content-center"><img src="images/10.png" alt="10" class="col-lg-6"></div>  
  Using the last log path, copy and paste it into the winlogbeat.yml file. 
  <div class="row mb-5 justify-content-center"><img src="images/11.png" alt="11" class="col-lg-6"></div>   
  Make sure the configuration file was edited correctly by testing with the same command as the previous edit, then install and start winlogbeat.
  Use PC1 to generate network activity, such as using a network share drive or browsing a webpage. 
</div>

<div class="row fw-bold m-0 p-0 mb-3">HIDS Agent Configuration</div>
<div class="row m-0 p-0">
  On PC1, Wazuh was installed as a HIDS Agent. Wazuh is a forked version of OSSEC from Security Onion. 
  The following command will associate PC1 with SIEM1.
  <code>“C:\Program Files (x86)\ossec-agent\agent-auth.exe” -m 10.1.0.246</code>
  In the Wazuh Agent Manager box, refreshing will automatically load an authentication key.
  SEIM1's IP address was added and saved, then the agent was started.
  <div class="row mb-5 justify-content-center"><img src="images/12.png" alt="12" class="col-lg-3"><img src="images/13.png" alt="13" class="col-lg-3"></div> 
</div>

<div class="row fw-bold m-0 p-0 mb-3">Kibana Query</div>
<div class="row m-0 p-0">
  On SIEM1 in Kibana, an index pattern was created named logstash-ossec-* without a time filter.
  <div class="row mb-5 justify-content-center"><img src="images/14.png" alt="14" class="col-lg-6"><img src="images/15.png" alt="15" class="col-lg-6"></div>
  The following query expression was used on logstash-ossec-* to view the PC1 activity.
  <div class="row mb-5 justify-content-center"><img src="images/16.png" alt="16" class="col-lg-6"><img src="images/17.png" alt="17" class="col-lg-6"></div>
</div>

<div class="row fw-bold m-0 p-0 mb-3">syslog Configuration</div>
<div class="row m-0 p-0">
  On PC1, the IP address 10.1.0.254 was used in the browser to access the pfSense interface on UTM1.
  In the System Log settings, remote logging was enabled.
  <div class="row mb-5 justify-content-center"><img src="images/18.png" alt="18" class="col-lg-6"><img src="images/19.png" alt="19" class="col-lg-6"></div>
  Lower in the settings, remote log server was set to 10.1.0.246:514 and filtered to System Events and Firewall Events only.
  <div class="row mb-5 justify-content-center"><img src="images/20.png" alt="20" class="col-lg-6"></div>
  Another index pattern was created in Kibana to query syslog-sourceip: 10.1.0.254. 
  syslog activity should be seen indicating syslog tracking by SIEM1.
</div>

</body>
</html>
